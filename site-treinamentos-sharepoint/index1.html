
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Treinamentos a Vencer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/pt-br.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/customParseFormat.js"></script>
  <script>dayjs.extend(dayjs_plugin_customParseFormat); dayjs.locale('pt-br');</script>
  <style>html{scroll-behavior:smooth}</style>
</head>
<body class="bg-slate-50 text-slate-800">
  <header class="sticky top-0 z-30 backdrop-blur bg-white/80 border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center gap-4">
      <div class="shrink-0 w-10 h-10 rounded-2xl bg-slate-900 text-white grid place-content-center font-semibold">TR</div>
      <div class="flex-1">
        <h1 class="text-xl md:text-2xl font-bold leading-tight">Treinamentos a Vencer</h1>
        <p class="text-sm text-slate-500">XLSX direto do SharePoint e fotos .jpeg por nome completo.</p>
      </div>
      <div class="flex items-center gap-2">
        <button id="btnExport" class="px-3 py-2 rounded-xl border border-slate-300 hover:bg-slate-100 text-sm">Exportar CSV</button>
        <a id="rawLink" href="https://rumolog.sharepoint.com/sites/AdernciaaoPDMInfraePonte/Documentos%20Compartilhados/0.%20MALHA%20SUL/02.%20PLANEJAMENTO/04.%20PLANO%20DE%20MANUTEN%C3%87%C3%83O/06.%20BI%27s/3.%20T.I/DOC%20-%20PORTAL%20INFRA/TreinamentosR0.xlsx" target="_blank" class="px-3 py-2 rounded-xl border border-slate-300 hover:bg-slate-100 text-sm">Fonte XLSX</a>
      </div>
    </div>
  </header>

  <section class="max-w-7xl mx-auto px-4 py-4 grid gap-4 md:grid-cols-12">
    <div class="md:col-span-4 lg:col-span-3">
      <label class="block text-xs font-medium text-slate-500">Buscar por nome</label>
      <input id="fNome" type="text" placeholder="Digite o nome" class="w-full mt-1 px-3 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-slate-300" />
    </div>
    <div class="md:col-span-4 lg:col-span-3">
      <label class="block text-xs font-medium text-slate-500">Formação</label>
      <select id="fFormacao" class="w-full mt-1 px-3 py-2 border rounded-xl bg-white"></select>
    </div>
    <div class="md:col-span-4 lg:col-span-3">
      <label class="block text-xs font-medium text-slate-500">Coordenação/Setor</label>
      <input id="fSetor" type="text" placeholder="Ex.: Infra, PDM..." class="w-full mt-1 px-3 py-2 border rounded-xl" />
    </div>
    <div class="md:col-span-12 lg:col-span-3">
      <label class="block text-xs font-medium text-slate-500">Janela de vencimento</label>
      <select id="fJanela" class="w-full mt-1 px-3 py-2 border rounded-xl bg-white">
        <option value="all">Todos</option>
        <option value="overdue">Vencidos</option>
        <option value="7">Até 7 dias</option>
        <option value="30">Até 30 dias</option>
        <option value="60">Até 60 dias</option>
        <option value="90">Até 90 dias</option>
        <option value="year">Este ano</option>
      </select>
    </div>
  </section>

  <section class="max-w-7xl mx-auto px-4 pb-2">
    <div id="chips" class="flex flex-wrap gap-2 text-xs"></div>
  </section>

  <section class="max-w-7xl mx-auto px-4 grid gap-4 md:grid-cols-4">
    <div class="p-4 rounded-2xl bg-white shadow border border-slate-200">
      <div class="text-xs text-slate-500">Total filtrado</div>
      <div id="kpiTotal" class="text-3xl font-semibold">0</div>
    </div>
    <div class="p-4 rounded-2xl bg-white shadow border border-slate-200">
      <div class="text-xs text-slate-500">Vencidos</div>
      <div id="kpiOverdue" class="text-3xl font-semibold">0</div>
    </div>
    <div class="p-4 rounded-2xl bg-white shadow border border-slate-200">
      <div class="text-xs text-slate-500">Vencem em 30 dias</div>
      <div id="kpi30" class="text-3xl font-semibold">0</div>
    </div>
    <div class="p-4 rounded-2xl bg-white shadow border border-slate-200">
      <div class="text-xs text-slate-500">Este ano</div>
      <div id="kpiYear" class="text-3xl font-semibold">0</div>
    </div>
  </section>

  <main class="max-w-7xl mx-auto px-4 py-6">
    <div id="grid" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4"></div>
    <div id="vazio" class="hidden mt-10 text-center text-slate-500">Nada a exibir com os filtros atuais.</div>
  </main>

  <script>
    const SHAREPOINT_XLSX_URL = "https://rumolog.sharepoint.com/sites/AdernciaaoPDMInfraePonte/Documentos%20Compartilhados/0.%20MALHA%20SUL/02.%20PLANEJAMENTO/04.%20PLANO%20DE%20MANUTEN%C3%87%C3%83O/06.%20BI%27s/3.%20T.I/DOC%20-%20PORTAL%20INFRA/TreinamentosR0.xlsx";
    const FOTOS_BASE = "https://rumolog.sharepoint.com/sites/AdernciaaoPDMInfraePonte/Documentos%20Compartilhados/0.%20MALHA%20SUL/02.%20PLANEJAMENTO/04.%20PLANO%20DE%20MANUTEN%C3%87%C3%83O/06.%20BI%27s/3.%20T.I/DOC%20-%20PORTAL%20INFRA/Fotos%20Treinamentos";
    const PESSOAS_RAW = [{"nome": "Thalita Cristina Santos Jacojaco", "data": "07/ago", "dep": "Planejamento", "email": "thalita.jacojaco@rumolog.com"}, {"nome": "Matias Alejandro Aduco", "data": "21/fev", "dep": "Institucional e Faixa de Domínio", "email": "matias.aduco@rumolog.com"}, {"nome": "Priscyla Oliveira de Mello", "data": "23/fev", "dep": "Engenharia", "email": "priscyla.mello@rumolog.com"}, {"nome": "Priscila de Christan", "data": "04/fev", "dep": "OAE's", "email": "priscila.christan@rumolog.com"}, {"nome": "Rafael Robert Nahra", "data": "05/jan", "dep": "Execução CN", "email": "rafael.nahra@rumolog.com"}, {"nome": "Hevellyn Cristina de Oliveira Alves", "data": "15/jan", "dep": "Planejamento", "email": "hevellyn.alves@rumolog.com"}, {"nome": "Ricardo Assumpcao Junior", "data": "01/jul", "dep": "Institucional e Faixa de Domínio", "email": "ricardoaj@rumolog.com"}, {"nome": "Thainá de Fátima Rosa Lopes", "data": "06/jul", "dep": "Execução CS", "email": "Thaina.Lopes@rumolog.com"}, {"nome": "Israel Riegel", "data": "24/jul", "dep": "Execução RS", "email": "Israel.Riegel@ext.rumolog.com"}, {"nome": "Roberto Benedito Antunes", "data": "21/jun", "dep": "OBRAS", "email": "roberto.antunes@rumolog.com"}, {"nome": "Helder da Silva Barbosa", "data": "04/jun", "dep": "OAE's", "email": "Helder.Barbosa@rumolog.com"}, {"nome": "Vitor Cerqueira dos Santos", "data": "05/jun", "dep": "Planejamento", "email": "vitor.cerqueira@rumolog.com"}, {"nome": "Luis Felipe Martinelli Martins", "data": "03/mai", "dep": "Execução RS", "email": "luis.martins@rumolog.com"}, {"nome": "Luciano Frederico Stelle", "data": "02/nov", "dep": "OBRAS", "email": "luciano.stelle@rumolog.com"}, {"nome": "Victor Hugo Miranda Oliveira", "data": "07/nov", "dep": "Planejamento", "email": "victor.miranda@rumolog.com"}, {"nome": "Vitoria Araujo dos Santos", "data": "12/nov", "dep": "Planejamento", "email": "vitoria.santos@rumolog.com"}, {"nome": "Nicholas Matheus Bachaus Stein", "data": "15/nov", "dep": "Engenharia", "email": "nicholas.stein@rumolog.com"}, {"nome": "Vitor Hugo Tonini", "data": "29/nov", "dep": "Execução CN", "email": "Vitor.Tonini@rumolog.com"}, {"nome": "Derick Leonardo da Silva Lisboa", "data": "28/out", "dep": "OAE's", "email": "derick.lisboa@rumolog.com"}, {"nome": "Jennifer Desiree M Cavalheiro Cúnico", "data": "02/out", "dep": "OAE's", "email": "jennifer.cunico@rumolog.com"}, {"nome": "Livia Cristina Guimaraes Oliveira", "data": "29/out", "dep": "Institucional e Faixa de Domínio", "email": "Livia.Oliveira@ext.rumolog.com"}, {"nome": "Francisco Antonio Ramos de Faria Filho", "data": "07/set", "dep": "Execução CS", "email": "francisco.filho@rumolog.com"}, {"nome": "Thalita Iachitzki da Cruz", "data": "23/set", "dep": "Planejamento", "email": "thalita.cruz@rumolog.com"}, {"nome": "Kaue Ciesielski Stinglin", "data": "22/jan", "dep": "Institucional e Faixa de Domínio", "email": "Kaue.Stinglin@rumolog.com"}, {"nome": "Ricardo Gasparino Ribas", "data": "06/ago", "dep": "Gerente", "email": "ricardo.ribas@rumolog.com"}, {"nome": "Sergio Alves Neves Junior", "data": "13/mai", "dep": "Engenharia", "email": "Sergio.Junior@rumolog.com"}];

    const PESSOAS = (() => { const seen=new Set(); const out=[]; for(const p of PESSOAS_RAW){ const k=(p.nome||'').toLowerCase().trim(); if(!seen.has(k)){ seen.add(k); out.push(p); } } return out; })();
    const MAPA_POR_NOME = Object.fromEntries(PESSOAS.map(p => [(p.nome||'').toLowerCase().trim(), p]));

    const CONFIG = { COLUMNS: { nome: "Nome Completo", setor: "Setor", formacao: "Treinamento", vencimentoCol: "Vencimento" } };

    const norm = (s) => (s || "").toString().trim();
    const normLower = (s) => norm(s).toLowerCase();

    function parseDataFlex(value) { if(!value) return null; const str=norm(value);
      const formatos=["DD/MM/YYYY","D/M/YYYY","YYYY-MM-DD","DD/MM/YY","D/M/YY","YYYY/M/D","YYYY/MM/DD"];
      for(const f of formatos){ const d=dayjs(str, f, true); if(d.isValid()) return d; }
      const num=Number(str); if(!Number.isNaN(num)){ const base=dayjs("1899-12-30"); return base.add(num,"day"); }
      const n=dayjs(str); return n.isValid()?n:null; }

    function statusBadge(diffDias) { if (diffDias < 0) return {label:"Vencido",cls:"bg-red-100 text-red-700 border-red-200"};
      if(diffDias===0) return {label:"Vence hoje",cls:"bg-amber-100 text-amber-800 border-amber-200"};
      if(diffDias<=7)  return {label:"Até 7 dias",cls:"bg-amber-100 text-amber-800 border-amber-200"};
      if(diffDias<=30) return {label:"Até 30 dias",cls:"bg-yellow-100 text-yellow-800 border-yellow-200"};
      if(diffDias<=60) return {label:"Até 60 dias",cls:"bg-lime-100 text-lime-800 border-lime-200"};
      if(diffDias<=90) return {label:"Até 90 dias",cls:"bg-emerald-100 text-emerald-800 border-emerald-200"};
      return {label:">90 dias",cls:"bg-slate-100 text-slate-700 border-slate-200"}; }

    function formatarData(d) { return d ? d.format("DD/MM/YYYY") : "-"; }
    function initialsFromName(name){ const parts=(name||'').trim().split(/\s+/); const first=parts[0]?.[0]||''; const last=parts.length>1?parts[parts.length-1][0]:''; return (first+last).toUpperCase(); }
    function fotoURLporNomeCompleto(nome){ const filename=encodeURIComponent(norm(nome)+".jpeg"); return FOTOS_BASE + "/" + filename; }

    function renderChips(formacoes) { const el=document.getElementById("chips"); el.innerHTML="";
      const make=(label,value)=>{ const b=document.createElement("button"); b.className="px-3 py-1.5 rounded-full border border-slate-300 hover:bg-slate-100"; b.textContent=label; b.onclick=()=>{ document.getElementById("fFormacao").value=value; aplicarFiltros(); }; return b; };
      el.appendChild(make("Todas as formações","")); formacoes.slice(0,14).forEach(f=>el.appendChild(make(f,f))); }
    function preencherComboFormacao(formacoes) { const sel=document.getElementById("fFormacao"); sel.innerHTML=""; sel.add(new Option("Todas","")); formacoes.forEach(f=>sel.add(new Option(f,f))); }

    let REGISTROS=[]; let REGISTROS_FILTRADOS=[];

    function atualizarKPIs(lista){ const hoje=dayjs(); let overdue=0,ate30=0,esteAno=0;
      lista.forEach(r=>{ const diff=r.diasParaVencer; if(diff<0)overdue++; if(diff>=0&&diff<=30)ate30++; if(r.vencimento&&r.vencimento.year()===hoje.year())esteAno++; });
      document.getElementById("kpiTotal").textContent=lista.length; document.getElementById("kpiOverdue").textContent=overdue; document.getElementById("kpi30").textContent=ate30; document.getElementById("kpiYear").textContent=esteAno; }

    function card(reg){ const { nome, setor, formacao, ultima, vencimento, diasParaVencer } = reg;
      const pessoa=MAPA_POR_NOME[(nome||'').toLowerCase().trim()]; const dep=pessoa?.dep || setor || ""; const badge=statusBadge(diasParaVencer);
      const foto=fotoURLporNomeCompleto(nome); const avId=`av_${Math.random().toString(36).slice(2)}`;
      return `
        <article class="p-4 rounded-2xl bg-white shadow border border-slate-200 flex flex-col gap-3">
          <div class="flex items-start justify-between gap-2">
            <div class="flex items-center gap-3">
              <img src="${foto}" alt="${initialsFromName(nome)}" class="w-14 h-14 rounded-xl object-cover border border-slate-200" onerror="this.style.display='none'; const av=document.getElementById('${avId}'); if(av) av.style.display='grid';" />
              <div id="${avId}" class="hidden w-14 h-14 rounded-xl border border-slate-200 grid place-items-center text-sm font-semibold bg-slate-100 text-slate-700">${initialsFromName(nome)}</div>
              <div><h3 class="font-semibold leading-tight">${nome || '-'}<span class="block text-sm text-slate-500">${dep || ''}</span></h3></div>
            </div>
            <span class="text-[11px] px-2 py-1 rounded-full border ${badge.cls}">${badge.label}</span>
          </div>
          <div class="text-sm">
            <div><span class="text-slate-500">Formação:</span> <span class="font-medium">${formacao || '-'}</span></div>
            <div><span class="text-slate-500">Vencimento:</span> <span class="font-medium">${formatarData(vencimento)}</span></div>
            <div class="text-slate-500 text-xs">${diasParaVencer < 0 ? `${Math.abs(diasParaVencer)} dia(s) em atraso` : `faltam ${diasParaVencer} dia(s)`}</div>
          </div>
        </article>`; }

    function aplicarFiltros(){ const q=normLower(document.getElementById("fNome").value);
      const f=normLower(document.getElementById("fFormacao").value); const s=normLower(document.getElementById("fSetor").value);
      const janela=document.getElementById("fJanela").value; const hoje=dayjs().startOf("day");
      REGISTROS_FILTRADOS = REGISTROS.filter(r=>{ const nomeOK=!q||normLower(r.nome).includes(q); const formOK=!f||normLower(r.formacao)===f; const setOK=!s||normLower(r.setor).includes(s);
        let janelaOK=true; const diff=r.diasParaVencer; if(janela==="overdue") janelaOK=diff<0; else if(["7","30","60","90"].includes(janela)) janelaOK=diff>=0 && diff<=Number(janela);
        else if(janela==="year") janelaOK=r.vencimento && r.vencimento.year()===hoje.year(); return nomeOK && formOK && setOK && janelaOK; });
      const grid=document.getElementById("grid"); const vazio=document.getElementById("vazio"); grid.innerHTML = REGISTROS_FILTRADOS.map(card).join("");
      vazio.classList.toggle("hidden", REGISTROS_FILTRADOS.length>0); atualizarKPIs(REGISTROS_FILTRADOS); }

    function exportCSV(){ if(!REGISTROS_FILTRADOS.length) return;
      const rows=REGISTROS_FILTRADOS.map(r=>({Nome:r.nome,Setor:r.setor,Formacao:r.formacao,Vencimento:r.vencimento?r.vencimento.format("YYYY-MM-DD"):"",DiasParaVencer:r.diasParaVencer}));
      const csv = rows.map(o=>Object.values(o).map(v=>`"${(v??'').toString().replaceAll('"','""')}"`).join(",")).join("\n");
      const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download=`treinamentos_filtrados_${dayjs().format("YYYYMMDD_HHmm")}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }

    async function carregarXLSX(){ const res=await fetch(SHAREPOINT_XLSX_URL, {credentials:"include"}); const ab=await res.arrayBuffer();
      const wb=XLSX.read(ab,{type:"array"}); const sheetName=wb.SheetNames[0]; const json=XLSX.utils.sheet_to_json(wb.Sheets[sheetName], {defval:""}); return json; }

    function prepararRegistros(linhas){ const C=CONFIG.COLUMNS; const hoje=dayjs().startOf("day"); const permitido=new Set(Object.keys(MAPA_POR_NOME)); const regs=[];
      for(const row of linhas){ const nome=norm(row[C.nome]); if(!nome||!permitido.has(nome.toLowerCase().trim())) continue;
        const setor=norm(row[C.setor]); const formacao=norm(row[C.formacao]); const venc=parseDataFlex(row[C.vencimentoCol]); if(!formacao||!venc) continue;
        const diff=venc.diff(hoje,"day"); regs.push({nome,setor,formacao,ultima:null,vencimento:venc,diasParaVencer:diff}); }
      regs.sort((a,b)=>a.diasParaVencer-b.diasParaVencer); return regs; }

    function debounce(fn, wait=250){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(null,args),wait); }; }

    (async ()=>{ try{ const linhas=await carregarXLSX(); REGISTROS=prepararRegistros(linhas);
        const setForm = Array.from(new Set(REGISTROS.map(r => r.formacao))).sort((a,b)=>a.localeCompare(b));
        preencherComboFormacao(setForm); renderChips(setForm); aplicarFiltros();
      }catch(e){ console.error("Falha ao carregar XLSX:", e);
        document.getElementById("grid").innerHTML=`<div class="col-span-full p-6 rounded-2xl bg-white border border-red-200 text-red-700">Erro ao carregar os dados do SharePoint. Verifique permissões e o arquivo <b>TreinamentosR0.xlsx</b>.</div>`; }
      document.getElementById("fNome").addEventListener("input", debounce(aplicarFiltros));
      document.getElementById("fFormacao").addEventListener("change", aplicarFiltros);
      document.getElementById("fSetor").addEventListener("input", debounce(aplicarFiltros));
      document.getElementById("fJanela").addEventListener("change", aplicarFiltros);
      document.getElementById("btnExport").addEventListener("click", exportCSV);
    })();
  </script>

  <footer class="max-w-7xl mx-auto px-4 py-8 text-center text-xs text-slate-500">
    Atualiza sozinho todo ano, lê XLSX do SharePoint e usa fotos .jpeg por nome completo.
  </footer>
</body>
</html>
